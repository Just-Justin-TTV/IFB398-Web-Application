{% extends 'base.html' %}
{% load static %}

{% block title %}Interventions - Carbon Management{% endblock %}

{% block page_title %}Carbon Calculator{% endblock %}
{% block page_subtitle %}Compare interventions, costs, and synergies to meet your targets{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Building Metrics Card -->
    <section class="bg-white border rounded-2xl shadow-sm overflow-hidden">
        <div class="px-6 py-4 border-b">
            <h2 class="text-lg font-semibold">Building Metrics</h2>
        </div>

        <!-- Top metrics inputs -->
        <form method="post" action="{% url 'calculator_results' %}" class="p-0">
            {% csrf_token %}
            <div class="w-full space-y-2">

                <!-- Roof -->
                <div class="grid grid-cols-12 border-b">
                    <div class="col-span-12 md:col-span-5 px-6 py-3 font-medium">Roof Area / % GIFA</div>
                    <div class="col-span-12 md:col-span-7 px-6 py-3 flex items-center gap-2">
                        <input id="roof_area" name="roof_area" type="number" value="{{ roof_area|default:'0' }}" class="w-44 rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand/30 focus:border-brand">
                        <span>m² /</span><span id="roof_pct">— %</span>
                    </div>
                </div>

                <!-- Building Type -->
                <div class="grid grid-cols-12 border-b">
                    <div class="col-span-12 md:col-span-5 px-6 py-3 font-medium">Building Type</div>
                    <div class="col-span-12 md:col-span-7 px-6 py-3">
                        <select id="building_type" name="building_type" class="w-full md:w-[28rem] rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand/30 focus:border-brand">
                            <option {% if building_type == 'Residential - Apartment Block' %}selected{% endif %}>Residential - Apartment Block</option>
                            <option {% if building_type == 'Residential - Single Family' %}selected{% endif %}>Residential - Single Family</option>
                            <option {% if building_type == 'Commercial - Office' %}selected{% endif %}>Commercial - Office</option>
                            <option {% if building_type == 'Education - School' %}selected{% endif %}>Education - School</option>
                            <option {% if building_type == 'Healthcare' %}selected{% endif %}>Healthcare</option>
                            <option {% if building_type == 'Industrial / Logistics' %}selected{% endif %}>Industrial / Logistics</option>
                        </select>
                    </div>
                </div>

                <!-- Basement -->
                <div class="grid grid-cols-12 border-b" id="basement_row">
                    <div class="col-span-12 md:col-span-5 px-6 py-3 font-medium">Basement (Y/N)</div>
                    <div class="col-span-12 md:col-span-7 px-6 py-3">
                        <input type="checkbox" id="has_basement" name="has_basement" {% if has_basement %}checked{% endif %} onchange="toggleBasement()" class="rounded border-gray-300 text-brand focus:ring-brand">
                        <span id="basement_chip">{% if has_basement %}Yes{% else %}No{% endif %}</span>
                    </div>
                </div>

                <!-- Basement Size -->
                <div class="grid grid-cols-12 border-b">
                    <div class="col-span-12 md:col-span-5 px-6 py-3 font-medium">Basement Size / % GIFA</div>
                    <div class="col-span-12 md:col-span-7 px-6 py-3 flex items-center gap-2">
                        <input id="basement_area" name="basement_area" type="number" value="{{ basement_area|default:'0' }}" class="w-44 rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand/30 focus:border-brand">
                        <span>m² /</span><span id="basement_pct">— %</span>
                    </div>
                </div>

                <!-- Apartments / Keys / WCS -->
                <div class="grid grid-cols-12 border-b">
                    <div class="col-span-12 md:col-span-5 px-6 py-3 font-medium">No of Apartments / Keys / WCS</div>
                    <div class="col-span-12 md:col-span-7 px-6 py-3 grid grid-cols-3 gap-4">
                        <input id="apartments" name="apartments" type="number" value="{{ apartments|default:'0' }}" oninput="combineLine()" class="rounded-xl border border-gray-300 px-3 py-2 text-center focus:outline-none focus:ring-2 focus:ring-brand/30 focus:border-brand">
                        <input id="keys" name="keys" type="number" value="{{ keys|default:'0' }}" oninput="combineLine()" class="rounded-xl border border-gray-300 px-3 py-2 text-center focus:outline-none focus:ring-2 focus:ring-brand/30 focus:border-brand">
                        <input id="wcs" name="wcs" type="number" value="{{ wcs|default:'0' }}" oninput="combineLine()" class="rounded-xl border border-gray-300 px-3 py-2 text-center focus:outline-none focus:ring-2 focus:ring-brand/30 focus:border-brand">
                    </div>
                </div>
                <div class="px-6 py-2 text-sm text-gray-600" id="combined_line"></div>

                <!-- Divider -->
                <div class="h-8 bg-gray-700"></div>

                <!-- Reference Metrics -->
                <div class="grid grid-cols-12 border-b">
                    <div class="col-span-5 px-6 py-3">GIFA (m²)</div>
                    <div class="col-span-7 px-6 py-3">
                        <input id="gifa_input" name="gifa" type="number" value="{{ GIFA|default:'0' }}" oninput="recalc()" class="w-44 rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand/30 focus:border-brand">
                    </div>
                </div>

                <div class="grid grid-cols-12 border-b">
                    <div class="col-span-5 px-6 py-3">External Wall Area (m²)</div>
                    <div class="col-span-7 px-6 py-3">
                        <input id="wall_area_input" name="external_wall_area" type="number" value="{{ external_wall_area|default:'0' }}" oninput="recalc()" class="w-44 rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand/30 focus:border-brand">
                    </div>
                </div>

                <div class="grid grid-cols-12 border-b">
                    <div class="col-span-5 px-6 py-3">External Openings (m²)</div>
                    <div class="col-span-7 px-6 py-3">
                        <input id="openings_input" name="external_openings" type="number" value="{{ external_openings|default:'0' }}" oninput="recalc()" class="w-44 rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand/30 focus:border-brand">
                    </div>
                </div>

                <div class="grid grid-cols-12 border-b">
                    <div class="col-span-5 px-6 py-3">Building Footprint (m²)</div>
                    <div class="col-span-7 px-6 py-3">
                        <input id="footprint_input" name="building_footprint" type="number" value="{{ building_footprint|default:'0' }}" oninput="recalc()" class="w-44 rounded-xl border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand/30 focus:border-brand">
                    </div>
                </div>

                <div class="grid grid-cols-12">
                    <div class="col-span-12 px-6 py-3 space-y-2" id="metrics_display"></div>
                </div>
            </div>
        </form>
    </section>

    <!-- Budget & Targets Card -->
    <section class="bg-white border rounded-2xl shadow-sm p-6">
        <h2 class="text-lg font-semibold mb-4">Set Target Impact Ratings and Global Budget</h2>
        
        <form id="targetsForm" action="/calculator/" method="post" class="space-y-4">
            {% csrf_token %}
            
            <div>
                <label for="global_budget" class="block text-sm font-medium text-gray-700 mb-2">
                    <strong>Total Budget (AUD):</strong>
                </label>
                <input type="number" name="global_budget" value="0" min="0" 
                       class="w-full md:w-72 rounded-xl border border-gray-300 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-brand/30 focus:border-brand">
            </div>

            {% for entry in class_targets %}
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">{{ entry.class }}</label>
                <input type="number" name="class_{{ entry.class }}" value="{{ entry.target_rating|floatformat:0 }}" min="0" step="1" 
                       class="w-full md:w-72 rounded-xl border border-gray-300 px-4 py-3 focus:outline-none focus:ring-2 focus:ring-brand/30 focus:border-brand">
            </div>
            {% endfor %}

            <!-- Hidden slot for metrics_id (filled after save) -->
            <input type="hidden" name="metrics_id" id="metrics_id">

            <button type="submit" id="generateBtn"
                    class="inline-flex items-center gap-2 rounded-full bg-brand px-6 py-3 text-white text-sm font-medium shadow-sm hover:bg-brand-600 transition-colors">
                <span class="material-icons text-[18px]">build</span>
                Generate Interventions
            </button>
        </form>
    </section>
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40"></div>

    <div class="relative mx-auto my-12 max-w-2xl">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="px-6 py-4 border-b">
                <h3 class="text-lg font-semibold">Saved Building Metrics</h3>
                <p class="text-sm text-gray-600">Here's what was saved. Click "Okay" to continue.</p>
            </div>

            <div class="p-6">
                <div id="confirmList" class="space-y-2 text-sm"></div>
            </div>

            <div class="px-6 py-4 border-t text-right">
                <button id="confirmOkBtn"
                        class="inline-flex items-center gap-2 rounded-full bg-brand px-5 py-2 text-white font-medium shadow-sm hover:bg-brand-600 transition-colors">
                    Okay
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleBasement(){
        const cb = document.getElementById('has_basement');
        const chip = document.getElementById('basement_chip');
        chip.textContent = cb.checked ? 'Yes' : 'No';
        recalc();
    }

    function combineLine(){
        const a = Number(document.getElementById('apartments').value)||0;
        const k = Number(document.getElementById('keys').value)||0;
        const w = Number(document.getElementById('wcs').value)||0;
        document.getElementById('combined_line').textContent = `Total Units: ${a+k+w}`;
    }

    function recalc(){
        const roof = Number(document.getElementById('roof_area').value)||0;
        const gifa = Number(document.getElementById('gifa_input').value)||6000;
        const basement = Number(document.getElementById('basement_area').value)||0;
        const footprint = Number(document.getElementById('footprint_input').value)||0;
        const openings = Number(document.getElementById('openings_input').value)||0;
        const wall = Number(document.getElementById('wall_area_input').value)||2200;
        const levels = Number(document.getElementById('levels_input')?.value)||4;

        const roofPct = gifa ? (roof/gifa*100).toFixed(1) : '—';
        const basementPct = gifa ? (basement/gifa*100).toFixed(1) : '—';

        document.getElementById('roof_pct').textContent = `${roofPct} %`;
        document.getElementById('basement_pct').textContent = `${basementPct} %`;

        const metricsDiv = document.getElementById('metrics_display');
        metricsDiv.innerHTML = `
            <div>Roof % of GIFA: ${roofPct}%</div>
            <div>Basement % of GIFA: ${basementPct}%</div>
            <div>Footprint % of GIFA: ${(footprint/gifa*100).toFixed(1)}%</div>
            <div>Openings % of facade: ${(openings/wall*100).toFixed(1)}%</div>
            <div>Wall:Floor %: ${(wall/(gifa*levels)*100).toFixed(1)}%</div>
        `;

        const autoBudget = roof*10 + basement*12 + footprint*8 + wall*15 + openings*5;
        metricsDiv.innerHTML += `<div class="mt-1 font-semibold text-green-600">
            Estimated Auto Budget: <span id="autoBudget">$${autoBudget.toLocaleString()}</span>
        </div>`;
    }

    // initial paint
    toggleBasement();
    combineLine();
    recalc();

    /* ---------- Confirmation modal helpers ---------- */
    function showModal() {
        document.getElementById('confirmModal').classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }
    function hideModal() {
        document.getElementById('confirmModal').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }

    function getCookie(name) {
        const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return m ? m.pop() : '';
    }

    /* ---------- Build payload & save ---------- */
    function buildPayload() {
        const roofArea   = Number(document.getElementById('roof_area').value) || 0;
        const gifa       = Number(document.getElementById('gifa_input').value) || 0;
        const basement   = Number(document.getElementById('basement_area').value) || 0;
        const wall       = Number(document.getElementById('wall_area_input').value) || 0;
        const openings   = Number(document.getElementById('openings_input').value) || 0;
        const footprint  = Number(document.getElementById('footprint_input').value) || 0;
        const levels     = Number(document.getElementById('levels_input')?.value) || 4;

        const roofPct     = gifa ? (roofArea / gifa * 100) : null;
        const basementPct = gifa ? (basement / gifa * 100) : null;
        const autoBudget  = roofArea*10 + basement*12 + footprint*8 + wall*15 + openings*5;

        return {
            building_type: document.getElementById('building_type').value,

            roof_area_m2: roofArea,
            roof_percent_gifa: roofPct,

            basement_present: !!document.getElementById('has_basement').checked,
            basement_size_m2: basement,
            basement_percent_gifa: basementPct,

            num_apartments: Number(document.getElementById('apartments').value) || 0,
            num_keys:       Number(document.getElementById('keys').value) || 0,
            num_wcs:        Number(document.getElementById('wcs').value) || 0,

            gifa_m2: gifa,
            external_wall_area_m2: wall,
            external_openings_m2: openings,
            building_footprint_m2: footprint,

            estimated_auto_budget_aud: autoBudget
        };
    }

    async function saveMetrics(payload) {
        const res = await fetch('/api/metrics/save/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload),
        });
        if (!res.ok) {
            const t = await res.text();
            throw new Error(`Metrics save failed: HTTP ${res.status} – ${t.slice(0,200)}`);
        }
        return res.json(); // { ok: true, metrics_id: ... }
    }

    function renderConfirmation(payload) {
        const fmt   = (n, unit='') => (n == null || isNaN(n)) ? '—' : `${Number(n).toLocaleString()}${unit}`;
        const pct   = (n) => (n == null || isNaN(n)) ? '—' : `${Number(n).toFixed(1)}%`;
        const money = (n) => (n == null || isNaN(n)) ? '—' : `$${Number(n).toLocaleString()}`;

        const html = `
            <div class="grid grid-cols-2 gap-y-1">
                <div class="text-gray-500">Building Type</div><div class="font-medium">${payload.building_type || '—'}</div>

                <div class="text-gray-500">Roof Area</div><div class="font-medium">${fmt(payload.roof_area_m2, ' m²')}</div>
                <div class="text-gray-500">Roof % GIFA</div><div class="font-medium">${pct(payload.roof_percent_gifa)}</div>

                <div class="text-gray-500">Basement Present</div><div class="font-medium">${payload.basement_present ? 'Yes' : 'No'}</div>
                <div class="text-gray-500">Basement Size</div><div class="font-medium">${fmt(payload.basement_size_m2, ' m²')}</div>
                <div class="text-gray-500">Basement % GIFA</div><div class="font-medium">${pct(payload.basement_percent_gifa)}</div>

                <div class="text-gray-500">No. of Apartments</div><div class="font-medium">${fmt(payload.num_apartments)}</div>
                <div class="text-gray-500">No. of Keys</div><div class="font-medium">${fmt(payload.num_keys)}</div>
                <div class="text-gray-500">No. of WCS</div><div class="font-medium">${fmt(payload.num_wcs)}</div>

                <div class="text-gray-500">GIFA</div><div class="font-medium">${fmt(payload.gifa_m2, ' m²')}</div>
                <div class="text-gray-500">External Wall Area</div><div class="font-medium">${fmt(payload.external_wall_area_m2, ' m²')}</div>
                <div class="text-gray-500">External Openings</div><div class="font-medium">${fmt(payload.external_openings_m2, ' m²')}</div>
                <div class="text-gray-500">Building Footprint</div><div class="font-medium">${fmt(payload.building_footprint_m2, ' m²')}</div>

                <div class="text-gray-500">Estimated Auto Budget</div><div class="font-semibold text-green-700">${money(payload.estimated_auto_budget_aud)}</div>
            </div>
        `;
        document.getElementById('confirmList').innerHTML = html;
    }

    // Wire the bottom form flow: save -> show modal -> on OK submit
    (function wireGenerate() {
        const form = document.getElementById('targetsForm');
        if (!form) return;

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const payload = buildPayload();
            let metricsId = null;
            try {
                const data = await saveMetrics(payload);
                if (data?.metrics_id) {
                    metricsId = String(data.metrics_id);
                    // store for later pages if needed
                    sessionStorage.setItem('metrics_id', metricsId);
                }
            } catch (err) {
                console.error(err);
                alert('Could not save building metrics. Check console/logs.');
                return; // stop here on failure
            }

            // show confirmation
            renderConfirmation(payload);
            showModal();

            // on OK -> inject metrics_id to the form and submit
            const okBtn = document.getElementById('confirmOkBtn');
            const metricsInput = document.getElementById('metrics_id');
            const onOk = () => {
                if (metricsId) metricsInput.value = metricsId;
                hideModal();
                okBtn.removeEventListener('click', onOk);
                form.submit();
            };
            okBtn.addEventListener('click', onOk, { once: true });
        });
    })();
</script>
{% endblock %}