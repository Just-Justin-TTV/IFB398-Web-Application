{% load static %}{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Carbon Calculator · Interventions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { extend: {
        colors: { brand: { DEFAULT:'#0ea5e9', 600:'#0891b2', 700:'#0e7490' } },
        borderRadius: { '2xl': '1rem' }
      }}
    }
  </script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body class="min-h-screen bg-gray-50 text-gray-900">
<div class="flex min-h-screen">
  <!-- Sidebar -->
  <aside class="w-64 shrink-0 bg-white border-r shadow-sm">
    <div class="px-5 py-6 border-b flex items-center gap-3">
      <img src="{% static 'images/img4.jpg' %}" alt="Logo" class="w-10 h-10 rounded-full object-cover">
      <div>
        <p class="text-xs text-gray-500">Welcome</p>
        <p class="text-sm font-semibold">{{ request.session.user_name }}</p>
      </div>
    </div>
    <nav class="px-3 py-4 space-y-1">
      <a href="{% url 'dashboard' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100">
        <span class="material-icons text-[18px]">dashboard</span> Dashboard
      </a>
      <a href="{% url 'projects' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100">
        <span class="material-icons text-[18px]">folder</span> Projects
      </a>
      <a href="{% url 'carbon' %}" class="flex items-center gap-3 px-3 py-2 rounded-lg bg-brand text-white shadow hover:bg-brand-600">
        <span class="material-icons text-[18px]">build</span> Interventions
      </a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="flex-1">
    <!-- Header -->
    <header class="bg-white border-b">
      <div class="max-w-7xl mx-auto px-6 py-5 flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-semibold">Carbon Calculator</h1>
          <p class="text-sm text-gray-600">Compare interventions, costs, and synergies to meet your targets</p>
        </div>
        <button id="saveBtn" class="inline-flex items-center gap-2 rounded-full bg-brand px-5 py-2.5 text-white font-medium shadow-sm hover:bg-brand-600">
          <span class="material-icons text-base">save</span> Save
        </button>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-6 py-6 space-y-5">
      <!-- Controls -->
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div class="flex flex-wrap items-center gap-3">
          <label class="text-sm text-gray-700">Select Class</label>
          <select id="classSelect" class="rounded-full border px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand/30 focus:border-brand">
            <option value="all" selected>All</option>
            <option value="carbon">Carbon</option>
            <option value="health">Health & Wellbeing</option>
            <option value="water">Water Use</option>
            <option value="circular">Circular Economy</option>
            <option value="resilience">Resilience</option>
            <option value="biodiversity">Biodiversity</option>
            <option value="value">Value & Cost</option>
          </select>

          <button id="resetBtn" class="rounded-full bg-gray-900 text-white text-sm px-4 py-2 hover:bg-gray-800">Reset</button>

          <label class="text-sm text-gray-700">Sort</label>
          <select id="orderSelect" class="rounded-full border px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand/30 focus:border-brand">
            <option value="best" selected>Best value (rating ÷ cost)</option>
            <option value="impact">Highest ranking</option>
            <option value="cost">Lowest cost</option>
            <option value="theme">Original order (by theme)</option>
          </select>
        </div>

        <!-- Search with suggestions -->
        <div class="relative w-full sm:w-96">
          <span class="material-icons absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-[18px]">search</span>
          <input id="searchBox" type="text" placeholder="Search interventions…"
                 class="w-full rounded-full border pl-9 pr-10 py-2 text-sm bg-white focus:outline-none focus:ring-2 focus:ring-brand/30 focus:border-brand"
                 autocomplete="off" />
          <button id="clearSearch"
                  class="hidden material-icons absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 text-[18px]">close</button>
          <div id="searchSuggest"
               class="absolute z-10 mt-2 w-full bg-white border rounded-xl shadow-lg overflow-hidden hidden"></div>
        </div>

        <div class="rounded-full bg-white border px-4 py-2 text-sm shadow-sm">
          <span class="text-gray-500">Cost Tracker:</span>
          <span id="costTracker" class="font-semibold ml-1">$0</span>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Table -->
        <section class="lg:col-span-2 bg-white border rounded-2xl shadow-sm overflow-hidden">
          <div class="grid grid-cols-12 items-center bg-gray-50 text-xs font-semibold uppercase tracking-wide text-gray-500">
            <div class="col-span-6 px-4 py-3">Intervention</div>
            <div class="col-span-2 px-4 py-3 text-center">Cost</div>
            <div class="col-span-2 px-4 py-3 text-center">Rating</div>
            <div class="col-span-2 px-4 py-3 text-center">Select</div>
          </div>
          <!-- rows injected by JS -->
          <div id="rows"></div>
        </section>

        <!-- Sidebar summary -->
        <aside class="space-y-6">
          <div class="bg-white border rounded-2xl shadow-sm">
            <div class="px-4 py-3 border-b"><h3 class="font-semibold">Progress</h3></div>
            <div class="p-4 space-y-2 text-sm text-gray-700">
              <div class="flex justify-between"><span>Selected items</span><span id="selCount">0</span></div>
              <div class="flex justify-between"><span>Total cost level</span><span id="totalCost">0</span></div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </main>
</div>

<script>
/* ===== Persist & read latest metrics id so API filters by building metrics ===== */
(function syncMidFromUrl(){
  const u = new URL(window.location.href);
  const qmid = u.searchParams.get('mid');
  if (qmid) sessionStorage.setItem('metrics_id', qmid);
})();
const METRICS_ID = sessionStorage.getItem('metrics_id') || '{{ request.session.metrics_id|default:"" }}';

/* ===== Utilities ===== */
const qs  = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));
const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
const family = name => String(name||'').replace(/stage\s*[ivx0-9]+/gi,'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
const stageFrom = t => {
  if (!t) return null;
  let m = String(t).match(/stage\s*0*([1-9]\d*)/i);
  if (m) return parseInt(m[1],10);
  m = String(t).match(/stage\s*(i{1,3}|iv|v|vi{0,3}|ix|x)/i);
  if (m){ const map={i:1,ii:2,iii:3,iv:4,v:5,vi:6,vii:7,viii:8,ix:9,x:10}; return map[m[1].toLowerCase()]||null; }
  return null;
};

/* ===== State ===== */
let RAW = [];  // flat list from API
const state = { selected: new Set(), query: '', classKey: 'all', sort: 'best' };

/* ===== Fetch from API: always include mid, include cls unless "all" ===== */
async function loadInterventions() {
  const qsx = new URLSearchParams();
  if (METRICS_ID) qsx.set('mid', METRICS_ID);
  if (state.classKey && state.classKey !== 'all') qsx.set('cls', state.classKey);

  const res = await fetch(`/api/interventions/?${qsx.toString()}`);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const data = await res.json();

  RAW = (data.items || []).map(it => ({
    id: String(it.id),
    name: it.name,
    theme: it.theme || 'Other',
    description: it.description || '',
    costLevel: Number(it.cost_level ?? 0),
    rating: Number(it.intervention_rating ?? 0),
    stage: stageFrom(it.description) ?? stageFrom(it.name),
    family: family(it.name),
  }));

  // Optional: look in devtools → Network for /api/interventions/ “debug”
  // to verify metrics_id and counts.
}

/* ===== Sorting & filtering ===== */
const valueScore = r => (Number(r.rating||0) / (Number(r.costLevel||0) + 0.001));
function cmp(mode){
  return (a,b)=>{
    if (mode==='impact'){
      if ((b.rating||0)!==(a.rating||0)) return (b.rating||0)-(a.rating||0);
      return (a.costLevel||0)-(b.costLevel||0);
    }
    if (mode==='cost'){
      if ((a.costLevel||0)!==(b.costLevel||0)) return (a.costLevel||0)-(b.costLevel||0);
      return (b.rating||0)-(a.rating||0);
    }
    if (mode==='best'){
      const d = valueScore(b) - valueScore(a);
      if (d!==0) return d;
      if ((b.rating||0)!==(a.rating||0)) return (b.rating||0)-(a.rating||0);
      return (a.costLevel||0)-(b.costLevel||0);
    }
    return 0;
  };
}
function filtered(){
  const q = state.query.toLowerCase().trim();
  return RAW.filter(r => !q || r.name.toLowerCase().includes(q) || r.description.toLowerCase().includes(q));
}
function groupByTheme(items){
  const order=[], groups={};
  for (const r of items){
    const t = r.theme || 'Other';
    if (!groups[t]) { groups[t]=[]; order.push(t); }
    groups[t].push(r);
  }
  return {order, groups};
}

/* ===== Stage constraints + counters ===== */
function applyStageConstraints(){
  const maxSel = {};
  for (const r of RAW){
    if (r.stage==null) continue;
    if (state.selected.has(r.id)){
      if (!maxSel[r.family] || r.stage>maxSel[r.family]) maxSel[r.family]=r.stage;
    }
  }
  qsa('.intervention-row').forEach(el=>{
    const id = el.dataset.id;
    const r  = RAW.find(x=>x.id===id);
    const cb = el.querySelector('.select-intervention');
    const top= maxSel[r.family] ?? null;
    const disable = (r.stage!=null && top!=null && r.stage < top);
    cb.disabled = !!disable;
    if (disable){
      cb.checked = false;
      state.selected.delete(id);
      el.classList.add('opacity-60','bg-gray-50');
      if (!el.querySelector('.stage-disabled-badge')){
        el.querySelector('.name-line')?.insertAdjacentHTML(
          'beforeend',
          `<span class="stage-disabled-badge ml-2 inline-flex items-center rounded-full bg-gray-200 px-2 py-0.5 text-[11px] text-gray-700">Disabled by Stage ${top}</span>`
        );
      }
    } else {
      el.classList.remove('opacity-60','bg-gray-50');
      const b=el.querySelector('.stage-disabled-badge'); if (b) b.remove();
    }
  });
}
function recalc(){
  applyStageConstraints();
  let total=0, count=0;
  qsa('.select-intervention').forEach(cb=>{
    const id=cb.dataset.id;
    cb.checked = state.selected.has(id);
    if (cb.checked){
      const r=RAW.find(x=>x.id===id);
      total += (r?.costLevel||0);
      count += 1;
    }
  });
  qs('#costTracker').textContent = String(total);
  qs('#selCount').textContent    = String(count);
  qs('#totalCost').textContent   = String(total);
}

/* ===== Render ===== */
function render(){
  const items = filtered();
  const {order, groups} = groupByTheme(items);
  if (state.sort!=='theme') for (const t of order) groups[t].sort(cmp(state.sort));

  if (!order.length){
    qs('#rows').innerHTML = `<div class="p-8 text-center text-gray-500">No interventions match your building metrics for this class.</div>`;
    recalc();
    return;
  }

  let html='';
  for (const t of order){
    html += `
      <div class="grid grid-cols-12">
        <div class="col-span-12 px-4 py-2 bg-gradient-to-r from-brand to-brand-700 text-white text-sm font-semibold">${esc(t)}</div>
      </div>`;
    for (const r of groups[t]){
      const stagePill = (r.stage!=null)
        ? `<span class="inline-flex items-center rounded-full bg-blue-50 text-blue-700 px-2 py-0.5 text-[11px] border border-blue-100">Stage ${r.stage}</span>`
        : '';
      const checked = state.selected.has(r.id) ? 'checked' : '';
      html += `
        <div class="grid grid-cols-12 items-center border-t hover:bg-gray-50 intervention-row" data-id="${esc(r.id)}">
          <div class="col-span-6 px-4 py-3 flex items-center justify-between">
            <div class="name-line">
              <div class="font-medium">${esc(r.name)}</div>
              <div class="mt-1 flex items-center gap-2">
                <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs text-gray-600">${esc(t)}</span>
                ${stagePill}
              </div>
            </div>
            <button class="toggle-desc text-gray-400 hover:text-gray-600 material-icons text-base ml-2">expand_more</button>
          </div>
          <div class="col-span-2 px-4 py-3 text-center">${r.costLevel||0}</div>
          <div class="col-span-2 px-4 py-3 text-center">${r.rating||0}</div>
          <div class="col-span-2 px-4 py-3 text-center">
            <input type="checkbox" class="select-intervention accent-brand" data-id="${esc(r.id)}" ${checked}>
          </div>
        </div>
        <div class="col-span-12 px-4 py-2 bg-gray-50 text-sm text-gray-700 description-row hidden">${esc(r.description)||'No description available.'}</div>
      `;
    }
  }
  qs('#rows').innerHTML = html;

  // bind row events
  qsa('.select-intervention').forEach(cb=>{
    cb.addEventListener('change', ()=>{
      const id = cb.dataset.id;
      if (cb.checked) state.selected.add(id); else state.selected.delete(id);
      recalc();
    });
  });
  qsa('.toggle-desc').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const row = btn.closest('.intervention-row');
      const desc = row.nextElementSibling;
      if (!desc) return;
      desc.classList.toggle('hidden');
      btn.textContent = desc.classList.contains('hidden') ? 'expand_more' : 'expand_less';
    });
  });

  recalc();
}

/* ===== Search + suggestions ===== */
const searchBox  = qs('#searchBox');
const clearBtn   = qs('#clearSearch');
const suggestBox = qs('#searchSuggest');
function closeSuggest(){ suggestBox.classList.add('hidden'); suggestBox.innerHTML=''; }
function buildSuggestions(q){
  const needle=(q||'').toLowerCase().trim(); if(!needle) return closeSuggest();
  const seen=new Set(), out=[];
  for (const r of RAW){
    const k=r.name.toLowerCase();
    if(!seen.has(k) && k.includes(needle)){ seen.add(k); out.push(r.name); if(out.length>=8) break; }
  }
  if(!out.length) return closeSuggest();
  suggestBox.innerHTML = out.map(n=>`<button type="button" class="w-full text-left px-3 py-2 hover:bg-gray-50 text-sm">${esc(n)}</button>`).join('');
  suggestBox.classList.remove('hidden');
  qsa('#searchSuggest button').forEach(b=>b.addEventListener('click',()=>{
    searchBox.value=b.textContent.trim(); state.query=searchBox.value; clearBtn.classList.remove('hidden'); render(); closeSuggest();
  }));
}
searchBox.addEventListener('input', e=>{ const v=e.target.value; state.query=v; clearBtn.classList.toggle('hidden',!v.length); buildSuggestions(v); render(); });
searchBox.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); closeSuggest(); } if(e.key==='Escape'){ closeSuggest(); }});
document.addEventListener('click', e=>{ if(!suggestBox.contains(e.target) && e.target!==searchBox) closeSuggest(); });
clearBtn.addEventListener('click', ()=>{ state.query=''; searchBox.value=''; clearBtn.classList.add('hidden'); closeSuggest(); render(); });

/* ===== Top control wiring ===== */
qs('#classSelect').addEventListener('change', async e=>{
  state.classKey = e.target.value || 'all';
  await loadInterventions();   // refetch from API with class + mid
  render();
});
qs('#orderSelect').addEventListener('change', e=>{ state.sort = e.target.value; render(); });
qs('#resetBtn').addEventListener('click', async ()=>{
  state.selected.clear();
  state.query=''; searchBox.value=''; clearBtn.classList.add('hidden');
  state.classKey='all'; qs('#classSelect').value='all';
  state.sort='best'; qs('#orderSelect').value='best';
  await loadInterventions();
  render();
});
qs('#saveBtn').addEventListener('click', ()=>{
  const payload = { selected:[...state.selected] };
  console.log('SAVE', payload);
  // TODO: POST to persist selections if you need to
});

/* ===== Boot ===== */
(async function init(){
  try {
    await loadInterventions();   // includes ?mid= so backend filters by building metrics
    render();
  } catch (err) {
    console.error(err);
    qs('#rows').innerHTML = `<div class="p-8 text-center text-red-600">Could not load interventions. Check the API and console.</div>`;
  }
})();
</script>
</body>
</html>
