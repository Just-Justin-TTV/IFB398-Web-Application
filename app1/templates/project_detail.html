{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}
    {% if p.project_name %}{{ p.project_name }} - Project{% else %}Project #{{ p.id }}{% endif %}
{% endblock %}

{% block page_title %}
    {% if p.project_name %}{{ p.project_name }}{% else %}Project #{{ p.id }}{% endif %}
{% endblock %}

{% block page_subtitle %}
    Last updated: {% if p.updated_at %}{{ p.updated_at|date:"d/m/Y H:i" }}{% else %}—{% endif %}
{% endblock %}

{% block content %}
<div class="max-w-5xl">
    <!-- Success toast after save -->
    {% if request.GET.saved %}
    <div class="fixed top-4 right-4 z-50 bg-green-600 text-white px-4 py-2 rounded-full shadow-lg animate-fade-in">
        Saved successfully. Your metrics are up to date.
    </div>
    <script>
        setTimeout(() => {
            const t = document.querySelector('.fixed.top-4');
            if (t) t.style.display = 'none';
        }, 2500);
    </script>
    {% endif %}

    <form id="projectForm" method="post" action="">
        {% csrf_token %}
        <div class="bg-white border rounded-2xl shadow-sm p-8 space-y-8">

            <!-- Basic info -->
            <div>
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Basic Information</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Project Name</label>
                        <input name="project_name" type="text" value="{{ p.project_name }}"
                               {% if not can_edit %}disabled{% endif %}
                               class="w-full rounded-xl border border-gray-300 px-4 py-3 {% if not can_edit %}bg-gray-50 text-gray-500{% endif %}">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Project Type</label>
                        <input name="building_type" type="text" value="{{ p.building_type }}"
                               {% if not can_edit %}disabled{% endif %}
                               class="w-full rounded-xl border border-gray-300 px-4 py-3 {% if not can_edit %}bg-gray-50 text-gray-500{% endif %}">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                        <input name="location" type="text" value="{{ p.location }}"
                               {% if not can_edit %}disabled{% endif %}
                               class="w-full rounded-xl border border-gray-300 px-4 py-3 {% if not can_edit %}bg-gray-50 text-gray-500{% endif %}">
                    </div>
                </div>
            </div>

            <!-- Building metrics -->
            <div>
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Building Metrics</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">GIFA (m²)</label>
                        <input name="gifa_m2" type="number" step="0.01" value="{{ p.gifa_m2 }}"
                               {% if not can_edit %}disabled{% endif %}
                               class="w-full rounded-xl border border-gray-300 px-4 py-3 {% if not can_edit %}bg-gray-50 text-gray-500{% endif %}">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">External Wall Area (m²)</label>
                        <input name="external_wall_area_m2" type="number" step="0.01" value="{{ p.external_wall_area_m2 }}"
                               {% if not can_edit %}disabled{% endif %}
                               class="w-full rounded-xl border border-gray-300 px-4 py-3 {% if not can_edit %}bg-gray-50 text-gray-500{% endif %}">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">External Openings (m²)</label>
                        <input name="external_openings_m2" type="number" step="0.01" value="{{ p.external_openings_m2 }}"
                               {% if not can_edit %}disabled{% endif %}
                               class="w-full rounded-xl border border-gray-300 px-4 py-3 {% if not can_edit %}bg-gray-50 text-gray-500{% endif %}">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Building Footprint (m²)</label>
                        <input name="building_footprint_m2" type="number" step="0.01" value="{{ p.building_footprint_m2 }}"
                               {% if not can_edit %}disabled{% endif %}
                               class="w-full rounded-xl border border-gray-300 px-4 py-3 {% if not can_edit %}bg-gray-50 text-gray-500{% endif %}">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Roof Area (m²)</label>
                        <input name="roof_area_m2" type="number" step="0.01" value="{{ p.roof_area_m2 }}"
                               {% if not can_edit %}disabled{% endif %}
                               class="w-full rounded-xl border border-gray-300 px-4 py-3 {% if not can_edit %}bg-gray-50 text-gray-500{% endif %}">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Roof % GIFA</label>
                        <input name="roof_percent_gifa" type="number" step="0.01" value="{{ p.roof_percent_gifa }}"
                               {% if not can_edit %}disabled{% endif %}
                               class="w-full rounded-xl border border-gray-300 px-4 py-3 {% if not can_edit %}bg-gray-50 text-gray-500{% endif %}">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Basement Size (m²)</label>
                        <input name="basement_size_m2" type="number" step="0.01" value="{{ p.basement_size_m2 }}"
                               {% if not can_edit %}disabled{% endif %}
                               class="w-full rounded-xl border border-gray-300 px-4 py-3 {% if not can_edit %}bg-gray-50 text-gray-500{% endif %}">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Basement % GIFA</label>
                        <input name="basement_percent_gifa" type="number" step="0.01" value="{{ p.basement_percent_gifa }}"
                               {% if not can_edit %}disabled{% endif %}
                               class="w-full rounded-xl border border-gray-300 px-4 py-3 {% if not can_edit %}bg-gray-50 text-gray-500{% endif %}">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Estimated Auto Budget (AUD)</label>
                        <input name="estimated_auto_budget_aud" type="number" step="0.01" value="{{ p.estimated_auto_budget_aud }}"
                               {% if not can_edit %}disabled{% endif %}
                               class="w-full rounded-xl border border-gray-300 px-4 py-3 {% if not can_edit %}bg-gray-50 text-gray-500{% endif %}">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">No. Apartments</label>
                        <input name="num_apartments" type="number" value="{{ p.num_apartments }}"
                               {% if not can_edit %}disabled{% endif %}
                               class="w-full rounded-xl border border-gray-300 px-4 py-3 {% if not can_edit %}bg-gray-50 text-gray-500{% endif %}">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">No. Keys</label>
                        <input name="num_keys" type="number" value="{{ p.num_keys }}"
                               {% if not can_edit %}disabled{% endif %}
                               class="w-full rounded-xl border border-gray-300 px-4 py-3 {% if not can_edit %}bg-gray-50 text-gray-500{% endif %}">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">No. WCs</label>
                        <input name="num_wcs" type="number" value="{{ p.num_wcs }}"
                               {% if not can_edit %}disabled{% endif %}
                               class="w-full rounded-xl border border-gray-300 px-4 py-3 {% if not can_edit %}bg-gray-50 text-gray-500{% endif %}">
                    </div>

                    <div class="md:col-span-3">
                        <label class="inline-flex items-center gap-2">
                            <input type="checkbox" name="basement_present" value="1"
                                   {% if p.basement_present %}checked{% endif %}
                                   {% if not can_edit %}disabled{% endif %}
                                   class="rounded border-gray-300 text-brand focus:ring-brand">
                            <span class="text-sm font-medium text-gray-700">Basement Present</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

    <!-- Sticky footer actions -->
    <div class="sticky bottom-0 bg-white/90 backdrop-blur border-t">
      <div class="max-w-5xl mx-auto px-6 py-4 flex items-center justify-end gap-3">
        <a href="{% url 'projects' %}"
           class="inline-flex items-center gap-2 rounded-full border px-5 py-2 text-sm hover:bg-gray-50">
          Cancel
        </a>

        {% if can_edit and request.GET.saved %}
          <a href="{% url 'calculator_results' %}"
             class="inline-flex items-center gap-2 rounded-full bg-brand px-6 py-2 text-white text-sm font-medium shadow-sm hover:bg-brand-600">
            Choose Interventions
            <span class="material-icons text-[18px]">arrow_forward</span>
          </a>
          <script>
            // After a successful save, scroll to show the new CTA
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
          </script>
        {% endif %}
      </div>
    </div>
    {% endif %}
</div>
{% endblock %}